<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed File Storage - Simple Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        /* Login Section */
        .login-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-form {
            display: inline-flex;
            gap: 10px;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .login-form input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            background: #4facfe;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #3d8bfe;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 40px;
        }

        .erasure-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .erasure-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
        }

        .erasure-option {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .erasure-option:hover {
            border-color: #4facfe;
        }

        .erasure-option.selected {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .drop-zone {
            border: 3px dashed #ccc;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .drop-zone.uploading {
            border-color: #28a745;
            background: #f0fff0;
        }

        .drop-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #4facfe;
        }

        /* File List Section */
        .file-list {
            margin-top: 30px;
        }

        .file-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .file-meta {
            font-size: 0.9rem;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }

        .hidden { display: none; }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s;
        }

        .user-info {
            background: #e8f5e8;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Share Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn[style*="background: #dc3545"]:hover {
            background: #c82333 !important;
            transform: translateY(-1px);
        }

        .btn[style*="background: #28a745"]:hover {
            background: #218838 !important;
            transform: translateY(-1px);
        }

        .folder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder-item:hover {
            background: #e9ecef;
        }

        .folder-item.selected {
            background: #d4edda;
            border-color: #28a745;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .breadcrumb-item {
            color: #4facfe;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            margin: 0 10px;
            color: #6c757d;
        }

        .breadcrumb-current {
            color: #495057;
            font-weight: 600;
        }

        .folder-actions {
            display: flex;
            gap: 5px;
        }

        .folder-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .file-folder-container {
            margin-top: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
        }

        .share-link {
            background: #f8f9fa;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Distributed File Storage</h1>
            <p>Reed-Solomon Erasure Coding with Fault Tolerance</p>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div id="loginSection" class="login-section">
                <h2>Login to Access Your Files</h2>
                <div class="login-form">
                    <input type="text" id="username" placeholder="Username" value="alice">
                    <input type="password" id="password" placeholder="Password" value="password123">
                    <button class="btn" onclick="login()">Login</button>
                </div>
                <div id="loginStatus"></div>
            </div>

            <!-- Main Interface (Hidden until logged in) -->
            <div id="mainInterface" class="hidden">
                <!-- User Info -->
                <div id="userInfo" class="user-info"></div>

                <!-- Upload Section -->
                <div class="upload-section">
                    <h2>üì§ Upload Files</h2>
                    
                    <div class="erasure-selector">
                        <label>Select Redundancy Level:</label>
                        <div class="erasure-options">
                            <div class="erasure-option" data-profile="LOW">
                                <strong>LOW</strong><br>
                                4+2=6 fragments
                            </div>
                            <div class="erasure-option selected" data-profile="MEDIUM">
                                <strong>MEDIUM</strong><br>
                                6+3=9 fragments
                            </div>
                            <div class="erasure-option" data-profile="HIGH">
                                <strong>HIGH</strong><br>
                                8+4=12 fragments
                            </div>
                        </div>
                    </div>

                    <div class="drop-zone" id="dropZone">
                        <div class="drop-icon">üìÅ</div>
                        <h3>Drag & Drop Files Here</h3>
                        <p>or <strong>click</strong> to select files</p>
                        <input type="file" id="fileInput" multiple style="display: none;">
                    </div>
                    
                    <div id="uploadProgress" class="hidden">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div id="progressText">Uploading...</div>
                    </div>
                </div>

                <!-- File List Section -->
                <div class="file-list">
                    <h2>üìÅ File Manager</h2>
                    
                    <!-- Breadcrumb Navigation -->
                    <div id="breadcrumb" class="breadcrumb">
                        <span class="breadcrumb-item" onclick="navigateToFolder(null)">üè† Home</span>
                    </div>
                    
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="loadCurrentFolder()">üîÑ Refresh</button>
                        <button class="btn btn-secondary" onclick="redirectToRubbishBin()">üóëÔ∏è Go to Rubbish Bin</button>
                        <button class="btn" style="background: #17a2b8; color: white;" onclick="openCreateFolderModal()">üìÅ New Folder</button>
                    </div>
                    
                    <div class="file-folder-container">
                        <!-- Folders Section -->
                        <div id="foldersSection" style="margin-bottom: 30px;">
                            <div class="section-header">
                                <span class="section-title">üìÅ Folders</span>
                            </div>
                            <div id="folderList"></div>
                        </div>
                        
                        <!-- Files Section -->
                        <div id="filesSection">
                            <div class="section-header">
                                <span class="section-title">üìÑ Files</span>
                            </div>
                            <div id="fileList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShareModal()">&times;</span>
            <h2>üîó Share File</h2>
            <div id="shareForm">
                <div class="form-group">
                    <label for="sharePassword">One-Time Password (Optional):</label>
                    <input type="password" id="sharePassword" placeholder="Leave empty for no password">
                </div>
                
                <div class="form-group">
                    <label for="sharePermissions">Permissions:</label>
                    <select id="sharePermissions">
                        <option value="VIEW">View Only</option>
                        <option value="DOWNLOAD">Download</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="shareExpiry">Expires In:</label>
                    <select id="shareExpiry">
                        <option value="">Never</option>
                        <option value="1">1 Hour</option>
                        <option value="24">24 Hours</option>
                        <option value="168">1 Week</option>
                        <option value="720">1 Month</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button class="btn" onclick="createShare()">Generate Share Link</button>
                    <button class="btn btn-secondary" onclick="closeShareModal()">Cancel</button>
                </div>
                
                <div id="shareResult" class="hidden">
                    <div class="form-group">
                        <label>Share Link:</label>
                        <div id="shareLink" class="share-link"></div>
                        <button class="btn" onclick="copyShareLink()">üìã Copy Link</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Move File Modal -->
    <div id="moveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMoveModal()">&times;</span>
            <h2>üìÅ Move File</h2>
            <div id="moveForm">
                <div class="form-group">
                    <label>Moving: <strong id="moveFileName"></strong></label>
                </div>
                
                <div class="form-group">
                    <label>Create New Folder:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newFolderName" placeholder="Enter folder name">
                        <button class="btn" onclick="createFolder()">Create</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Select Destination Folder:</label>
                    <div id="moveFolderList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: white;">
                        <div class="folder-item" data-folder-id="root">
                            <span>üìÅ Root Folder</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn" onclick="moveFile()">Move File</button>
                    <button class="btn btn-secondary" onclick="closeMoveModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Folder Modal -->
    <div id="createFolderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateFolderModal()">&times;</span>
            <h2>üìÅ Create New Folder</h2>
            <div id="createFolderForm">
                <div class="form-group">
                    <label for="createFolderName">Folder Name:</label>
                    <input type="text" id="createFolderName" placeholder="Enter folder name">
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn" onclick="createNewFolder()">Create Folder</button>
                    <button class="btn btn-secondary" onclick="closeCreateFolderModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let accessToken = null;
        let currentUser = null;
        let selectedProfile = 'MEDIUM';
        let currentFolderId = null; // null means root
        let folderPath = []; // Array to track folder hierarchy
        const API_BASE = 'http://localhost:8004';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // Erasure profile selection
            document.querySelectorAll('.erasure-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.erasure-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedProfile = this.dataset.profile;
                });
            });

            // Drop zone events
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Enter key for login
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('loginSection').classList.contains('hidden')) {
                    login();
                }
            });
        }

        // Authentication functions
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('loginStatus');

            if (!username || !password) {
                statusDiv.innerHTML = '<div class="status error">Please enter username and password</div>';
                return;
            }

            try {
                statusDiv.innerHTML = '<div class="status">Logging in...</div>';

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username_or_email: username,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.access_token;
                    currentUser = data.user;
                    
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainInterface').classList.remove('hidden');
                    
                    document.getElementById('userInfo').innerHTML = 
                        `Logged in as: <strong>${currentUser.username}</strong> (${currentUser.account_type})`;
                    
                    // Load current folder content
                    loadCurrentFolder();
                } else {
                    statusDiv.innerHTML = `<div class="status error">Login failed: ${data.detail}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Network error: ${error.message}</div>`;
            }
        }

        // File handling functions
        async function handleFiles(files) {
            for (let file of files) {
                await uploadFile(file);
            }
        }

        async function uploadFile(file) {
            const dropZone = document.getElementById('dropZone');
            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            try {
                dropZone.classList.add('uploading');
                progressDiv.classList.remove('hidden');
                progressText.innerHTML = `Uploading: ${file.name}`;
                progressFill.style.width = '10%';

                // Convert file to base64
                const base64Data = await fileToBase64(file);
                progressFill.style.width = '30%';

                const uploadData = {
                    filename: file.name,
                    data: base64Data.split(',')[1], // Remove data URL prefix
                    content_type: file.type || 'application/octet-stream',
                    folder_id: currentFolderId,
                    erasure_id: selectedProfile
                };

                progressFill.style.width = '50%';

                const response = await fetch(`${API_BASE}/files/upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(uploadData)
                });

                progressFill.style.width = '80%';

                const result = await response.json();

                if (response.ok) {
                    progressFill.style.width = '100%';
                    progressText.innerHTML = `‚úÖ Upload successful: ${file.name}`;
                    
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        dropZone.classList.remove('uploading');
                        loadCurrentFolder(); // Refresh current folder
                    }, 1500);
                } else {
                    throw new Error(result.detail || 'Upload failed');
                }

            } catch (error) {
                progressText.innerHTML = `‚ùå Upload failed: ${error.message}`;
                dropZone.classList.remove('uploading');
                
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                }, 3000);
            }
        }

        async function loadCurrentFolder() {
            await Promise.all([loadFolders(), loadFiles()]);
            updateBreadcrumb();
        }

        async function loadFolders() {
            const folderListDiv = document.getElementById('folderList');
            
            try {
                folderListDiv.innerHTML = '<div class="status">Loading folders...</div>';

                const response = await fetch(`${API_BASE}/folders/list`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const foldersInCurrentLocation = data.folders.filter(folder => {
                        const parentId = folder.parent_folder_id;
                        return (currentFolderId === null && parentId === null) || 
                               (currentFolderId !== null && parentId === currentFolderId);
                    });
                    
                    if (foldersInCurrentLocation.length > 0) {
                        folderListDiv.innerHTML = foldersInCurrentLocation.map(folder => createFolderItem(folder)).join('');
                    } else {
                        folderListDiv.innerHTML = '<div class="status">No folders in this location</div>';
                    }
                } else {
                    const error = await response.json();
                    folderListDiv.innerHTML = `<div class="status error">Failed to load folders: ${error.detail}</div>`;
                }
            } catch (error) {
                folderListDiv.innerHTML = `<div class="status error">Network error: ${error.message}</div>`;
            }
        }

        function createFolderItem(folder) {
            const createdDate = new Date(folder.created_at).toLocaleString();
            
            return `
                <div class="folder-item" data-folder-id="${folder.folder_id}" ondblclick="navigateToFolder('${folder.folder_id}', '${folder.name}')">
                    <div class="file-info">
                        <div class="file-name">üìÅ ${folder.name}</div>
                        <div class="file-meta">
                            Created: ${createdDate}
                        </div>
                    </div>
                    <div class="folder-actions">
                        <button class="btn" style="background: #17a2b8; font-size: 12px;" onclick="event.stopPropagation(); navigateToFolder('${folder.folder_id}', '${folder.name}')">
                            üîç Open
                        </button>
                        <button class="btn" style="background: #dc3545; font-size: 12px;" onclick="event.stopPropagation(); deleteFolder('${folder.folder_id}', '${folder.name}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `;
        }

        async function loadFiles() {
            const fileListDiv = document.getElementById('fileList');
            
            try {
                fileListDiv.innerHTML = '<div class="status">Loading files...</div>';

                const response = await fetch(`${API_BASE}/files/list`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    // Filter files by current folder
                    const filesInCurrentLocation = data.files ? data.files.filter(file => {
                        const fileFolderId = file.folder_id;
                        return (currentFolderId === null && fileFolderId === null) || 
                               (currentFolderId !== null && fileFolderId === currentFolderId);
                    }) : [];
                    
                    if (filesInCurrentLocation.length > 0) {
                        fileListDiv.innerHTML = filesInCurrentLocation.map(file => createFileItem(file)).join('');
                    } else {
                        fileListDiv.innerHTML = '<div class="status">No files in this location</div>';
                    }
                } else {
                    fileListDiv.innerHTML = `<div class="status error">Failed to load files: ${data.detail}</div>`;
                }
            } catch (error) {
                fileListDiv.innerHTML = `<div class="status error">Network error: ${error.message}</div>`;
            }
        }

        function createFileItem(file) {
            const uploadDate = new Date(file.uploaded_at).toLocaleString();
            const fileSize = formatFileSize(file.file_size);
            
            return `
                <div class="file-item" data-file-id="${file.file_id}">
                    <div class="file-info">
                        <div class="file-name">üìÑ ${file.file_name}</div>
                        <div class="file-meta">
                            Size: ${fileSize} | 
                            Uploaded: ${uploadDate} | 
                            Profile: ${file.erasure_id}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn" onclick="downloadFile('${file.file_id}', '${file.file_name}')">
                            üì• Download
                        </button>
                        <button class="btn btn-secondary" onclick="openShareModal('${file.file_id}', '${file.file_name}')">
                            üîó Share
                        </button>
                        <button class="btn" style="background: #28a745;" onclick="openMoveModal('${file.file_id}', '${file.file_name}')">
                            üìÅ Move
                        </button>
                        <button class="btn" style="background: #dc3545;" onclick="deleteFile('${file.file_id}', '${file.file_name}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `;
        }

        async function downloadFile(fileId, fileName) {
            try {
                const response = await fetch(`${API_BASE}/files/download/${fileId}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.json();
                    alert(`Download failed: ${error.detail}`);
                }
            } catch (error) {
                alert(`Network error: ${error.message}`);
            }
        }

        // Utility functions
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Sharing functions
        let currentShareFileId = null;
        let currentShareFileName = null;

        function openShareModal(fileId, fileName) {
            currentShareFileId = fileId;
            currentShareFileName = fileName;
            document.getElementById('shareModal').style.display = 'block';
            document.getElementById('shareResult').classList.add('hidden');
            // Reset form
            document.getElementById('sharePassword').value = '';
            document.getElementById('sharePermissions').value = 'VIEW';
            document.getElementById('shareExpiry').value = '';
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
            currentShareFileId = null;
            currentShareFileName = null;
        }

        async function createShare() {
            const password = document.getElementById('sharePassword').value;
            const permissions = document.getElementById('sharePermissions').value;
            const expiryHours = document.getElementById('shareExpiry').value;
            
            const requestBody = {
                file_id: currentShareFileId,
                permissions: permissions,
                require_password: password ? true : false
            };
            
            if (expiryHours) {
                requestBody.expires_hours = parseInt(expiryHours);
            }

            try {
                const response = await fetch(`${API_BASE}/shares/files/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const shareData = await response.json();
                    let shareUrl = `${window.location.origin}/file_sharing_demo.html?token=${shareData.share_token}`;
                    
                    if (shareData.one_time_password) {
                        shareUrl += `&password=${shareData.one_time_password}`;
                    }
                    
                    document.getElementById('shareLink').textContent = shareUrl;
                    document.getElementById('shareResult').classList.remove('hidden');
                } else {
                    const errorData = await response.json();
                    alert('Error creating share: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(shareLink).then(() => {
                alert('Share link copied to clipboard!');
            }).catch(() => {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = shareLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Share link copied to clipboard!');
            });
        }

        // Folder navigation functions
        function navigateToFolder(folderId, folderName) {
            if (folderId === null) {
                // Navigate to root
                currentFolderId = null;
                folderPath = [];
            } else {
                // Navigate to specific folder
                currentFolderId = folderId;
                
                // Add to path if not already there (avoid duplicates when clicking breadcrumb)
                const existingIndex = folderPath.findIndex(item => item.id === folderId);
                if (existingIndex !== -1) {
                    // Remove everything after this folder in the path
                    folderPath = folderPath.slice(0, existingIndex + 1);
                } else {
                    // Add new folder to path
                    folderPath.push({ id: folderId, name: folderName });
                }
            }
            
            loadCurrentFolder();
        }

        function updateBreadcrumb() {
            const breadcrumbDiv = document.getElementById('breadcrumb');
            let breadcrumbHtml = '<span class="breadcrumb-item" onclick="navigateToFolder(null)">üè† Home</span>';
            
            folderPath.forEach((folder, index) => {
                breadcrumbHtml += '<span class="breadcrumb-separator">/</span>';
                if (index === folderPath.length - 1) {
                    breadcrumbHtml += `<span class="breadcrumb-current">üìÅ ${folder.name}</span>`;
                } else {
                    breadcrumbHtml += `<span class="breadcrumb-item" onclick="navigateToFolder('${folder.id}', '${folder.name}')">üìÅ ${folder.name}</span>`;
                }
            });
            
            breadcrumbDiv.innerHTML = breadcrumbHtml;
        }

        // Create folder functions
        function openCreateFolderModal() {
            document.getElementById('createFolderModal').style.display = 'block';
            document.getElementById('createFolderName').value = '';
        }

        function closeCreateFolderModal() {
            document.getElementById('createFolderModal').style.display = 'none';
        }

        async function createNewFolder() {
            const folderName = document.getElementById('createFolderName').value.trim();
            
            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/folders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        name: folderName,
                        parent_folder_id: currentFolderId
                    })
                });

                if (response.ok) {
                    alert(`Folder "${folderName}" created successfully!`);
                    closeCreateFolderModal();
                    loadCurrentFolder();
                } else {
                    const error = await response.json();
                    alert(`Failed to create folder: ${error.detail}`);
                }
            } catch (error) {
                alert(`Network error: ${error.message}`);
            }
        }

        async function deleteFolder(folderId, folderName) {
            if (!confirm(`Are you sure you want to move folder "${folderName}" and all its contents to the rubbish bin? This will delete all files and subfolders inside it.`)) {
                return;
            }

            // Find the folder item for optimistic update
            const folderItem = document.querySelector(`.folder-item[data-folder-id="${folderId}"]`);
            let originalOpacity = null;
            let originalPointerEvents = null;
            
            try {
                // Optimistically dim the folder item to show it's being deleted
                if (folderItem) {
                    originalOpacity = folderItem.style.opacity;
                    originalPointerEvents = folderItem.style.pointerEvents;
                    folderItem.style.opacity = '0.5';
                    folderItem.style.pointerEvents = 'none';
                }

                const response = await fetch(`${API_BASE}/bin/delete-folder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        folder_id: folderId,
                        deletion_reason: 'USER_DELETE'
                    })
                });

                if (response.ok) {
                    // Success - remove the folder item completely
                    if (folderItem) {
                        folderItem.remove();
                    }
                    
                    const result = await response.json();
                    let message = `"${folderName}" has been moved to the rubbish bin.`;
                    
                    if (result.total_items_deleted > 1) {
                        const filesDeleted = result.files_deleted || 0;
                        const subfoldersDeleted = result.subfolders_deleted || 0;
                        const totalSize = result.total_files_size || 0;
                        
                        message += ` ${filesDeleted} files`;
                        if (totalSize > 0) {
                            message += ` (${formatFileSize(totalSize)})`;
                        }
                        message += ` and ${subfoldersDeleted} subfolders were also moved to the bin.`;
                    }
                    
                    showNotification(message, 'success');
                } else {
                    // Error - restore the folder item appearance
                    if (folderItem) {
                        folderItem.style.opacity = originalOpacity || '1';
                        folderItem.style.pointerEvents = originalPointerEvents || 'auto';
                    }
                    
                    const error = await response.json();
                    showNotification(`Failed to delete folder: ${error.detail}`, 'error');
                }
            } catch (error) {
                // Network error - restore the folder item appearance
                if (folderItem) {
                    folderItem.style.opacity = originalOpacity || '1';
                    folderItem.style.pointerEvents = originalPointerEvents || 'auto';
                }
                
                showNotification(`Network error: ${error.message}`, 'error');
            }
        }

        // Rubbish bin functions
        // Utility function to show notifications
        function showNotification(message, type = 'info') {
            // For now, use alert - in a production system, you'd use a proper notification system
            if (type === 'error') {
                alert(`‚ùå ${message}`);
            } else if (type === 'success') {
                alert(`‚úÖ ${message}`);
            } else {
                alert(message);
            }
        }

        // Utility function to update file count display
        function updateFileCount() {
            const fileItems = document.querySelectorAll('#fileList .file-item');
            const fileCount = fileItems.length;
            // Update any file count display if it exists
            const countElement = document.querySelector('#fileCount');
            if (countElement) {
                countElement.textContent = fileCount;
            }
        }

        async function deleteFile(fileId, fileName) {
            if (!confirm(`Are you sure you want to move "${fileName}" to the rubbish bin? You can restore it within 30 days.`)) {
                return;
            }

            // Find the file item for optimistic update
            const fileItem = document.querySelector(`.file-item[data-file-id="${fileId}"]`);
            let originalOpacity = null;
            let originalPointerEvents = null;
            
            try {
                // Optimistically dim the file item to show it's being deleted
                if (fileItem) {
                    originalOpacity = fileItem.style.opacity;
                    originalPointerEvents = fileItem.style.pointerEvents;
                    fileItem.style.opacity = '0.5';
                    fileItem.style.pointerEvents = 'none';
                }

                const response = await fetch(`${API_BASE}/bin/delete-file`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        file_id: fileId,
                        deletion_reason: 'USER_DELETE'
                    })
                });

                if (response.ok) {
                    // Success - remove the file item completely
                    if (fileItem) {
                        fileItem.remove();
                    }
                    
                    // Show success message
                    showNotification(`"${fileName}" has been moved to the rubbish bin. You can restore it within 30 days.`, 'success');
                    
                    // Update the file count if displayed
                    updateFileCount();
                } else {
                    // Error - restore the file item appearance
                    if (fileItem) {
                        fileItem.style.opacity = originalOpacity || '1';
                        fileItem.style.pointerEvents = originalPointerEvents || 'auto';
                    }
                    
                    const error = await response.json();
                    showNotification(`Failed to move file to rubbish bin: ${error.detail}`, 'error');
                }
            } catch (error) {
                // Network error - restore the file item appearance
                if (fileItem) {
                    fileItem.style.opacity = originalOpacity || '1';
                    fileItem.style.pointerEvents = originalPointerEvents || 'auto';
                }
                
                showNotification(`Network error: ${error.message}`, 'error');
            }
        }

        function redirectToRubbishBin() {
            // Redirect to the rubbish bin interface
            window.location.href = 'recycle_bin_interface.html';
        }

        // Move file functions
        let currentMoveFileId = null;
        let currentMoveFileName = null;
        let selectedFolderId = 'root';

        async function openMoveModal(fileId, fileName) {
            currentMoveFileId = fileId;
            currentMoveFileName = fileName;
            selectedFolderId = 'root';
            
            document.getElementById('moveFileName').textContent = fileName;
            document.getElementById('moveModal').style.display = 'block';
            
            // Load folders for move modal
            await loadFoldersForMove();
        }

        async function loadFoldersForMove() {
            try {
                const response = await fetch(`${API_BASE}/folders/list`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayFolders(data.folders || []);
                } else {
                    console.error('Failed to load folders');
                    displayFolders([]);
                }
            } catch (error) {
                console.error('Error loading folders:', error);
                displayFolders([]);
            }
        }

        function closeMoveModal() {
            document.getElementById('moveModal').style.display = 'none';
            currentMoveFileId = null;
            currentMoveFileName = null;
            selectedFolderId = 'root';
            document.getElementById('newFolderName').value = '';
        }

        function displayFolders(folders) {
            const folderList = document.getElementById('moveFolderList');
            let html = `
                <div class="folder-item ${selectedFolderId === 'root' ? 'selected' : ''}" data-folder-id="root" onclick="selectFolder('root')">
                    <span>üìÅ Root Folder</span>
                </div>
            `;
            
            folders.forEach(folder => {
                const isSelected = selectedFolderId === folder.folder_id;
                html += `
                    <div class="folder-item ${isSelected ? 'selected' : ''}" data-folder-id="${folder.folder_id}" onclick="selectFolder('${folder.folder_id}')">
                        <span>üìÅ ${folder.name}</span>
                    </div>
                `;
            });
            
            folderList.innerHTML = html;
        }

        function selectFolder(folderId) {
            selectedFolderId = folderId;
            
            // Update visual selection
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            document.querySelector(`[data-folder-id="${folderId}"]`).classList.add('selected');
        }

        async function createFolder() {
            const folderName = document.getElementById('newFolderName').value.trim();
            
            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/folders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        name: folderName,
                        parent_folder_id: selectedFolderId === 'root' ? null : selectedFolderId
                    })
                });

                if (response.ok) {
                    const newFolder = await response.json();
                    alert(`Folder "${folderName}" created successfully!`);
                    document.getElementById('newFolderName').value = '';
                    
                    // Reload folders and select the new one
                    await loadFolders();
                    selectFolder(newFolder.folder_id);
                } else {
                    const error = await response.json();
                    alert(`Failed to create folder: ${error.detail}`);
                }
            } catch (error) {
                alert(`Network error: ${error.message}`);
            }
        }

        async function moveFile() {
            if (!currentMoveFileId) {
                alert('No file selected for moving');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/folders/files/${currentMoveFileId}/move`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        new_folder_id: selectedFolderId === 'root' ? null : selectedFolderId
                    })
                });

                if (response.ok) {
                    const destinationName = selectedFolderId === 'root' ? 'Root Folder' : 
                        document.querySelector(`[data-folder-id="${selectedFolderId}"] span`).textContent.replace('üìÅ ', '');
                    
                    alert(`"${currentMoveFileName}" has been moved to "${destinationName}" successfully!`);
                    closeMoveModal();
                    loadCurrentFolder(); // Refresh current folder view
                } else {
                    const error = await response.json();
                    alert(`Failed to move file: ${error.detail}`);
                }
            } catch (error) {
                alert(`Network error: ${error.message}`);
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const shareModal = document.getElementById('shareModal');
            const moveModal = document.getElementById('moveModal');
            const createFolderModal = document.getElementById('createFolderModal');
            
            if (event.target == shareModal) {
                closeShareModal();
            } else if (event.target == moveModal) {
                closeMoveModal();
            } else if (event.target == createFolderModal) {
                closeCreateFolderModal();
            }
        }
    </script>
</body>
</html>